import{M as te,d as H,c as w,t as g,u as A,i as f,a as T,o as ne,b as ie,e as se,f as k,F as oe,S as V,r as le}from"./vendor-CfKRxhm_.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const c of o.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function e(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(i){if(i.ep)return;i.ep=!0;const o=e(i);fetch(i.href,o)}})();class re{client;topic;constructor({url:t,topic:e}){this.topic=e,this.client=te.connect(t,{reconnectPeriod:5e3})}set handleConnectEvent(t){const{client:e,topic:n}=this;e.on("connect",()=>{e.subscribe(n,i=>{i?console.error("Subscribe error:",i):(console.log(`Subscribed to topic: ${n}`),t())})})}set handleMessageEvent(t){const{client:e,topic:n}=this;e.on("message",(i,o)=>{const c=o.toString();console.log(`Received message on topic ${i}`),i===n&&t(c)})}set handleErrorEvent(t){const{client:e}=this;e.on("error",n=>{t(n)})}set handleCloseEvent(t){const{client:e}=this;e.on("close",()=>{t()})}send(t){const{client:e,topic:n}=this;e.publish(n,t,i=>{i?console.error("Publish error:",i):console.log(`Published message to topic: ${n}`)})}close(){this.client.end()}}window.name||(window.name=crypto.randomUUID());const ae=8*1024*1024,ce=1*1024*1024;class de{pc=null;dataChannel=null;cli;id=window.name;peerId;onMessage;onConnState;onPeerID;onStream;constructor({onMessage:t,onConnState:e,onPeerID:n,onStream:i}){console.log("初始化 WebRTCDemo",this.id);const o="wss://test.mosquitto.org:8081";this.cli=new re({url:o,topic:"test/webrtc/topic"}),this.onMessage=t,this.onConnState=e,this.onPeerID=n,this.onStream=i,this.cli.handleConnectEvent=()=>{console.log("成功连接到信令服务器"),this.initializePeerConnection(),this.onConnState("cli_connected")},this.cli.handleMessageEvent=async c=>{const r=JSON.parse(c);if(r.id!==this.id)if(console.log("从信令服务器收到消息:",r),r.type==="PeerID")this.onPeerID(r.id);else if(r.type==="Reload")console.log("Reload",r),this.onMessage(r),this.sendSignalingMessage({type:"Reloading",id:this.id}),setTimeout(()=>{window.location.reload()},2e3);else if(r.type==="Reloading")console.log("Reloading",r);else if(r.offer){if(r.offer.peerId!==this.id)return;await this.receiveOffer(r.id,r.offer.desc)}else r.answer?await this.receiveAnswer(r.answer):r.candidate&&await this.addIceCandidate(r.candidate)},this.cli.handleErrorEvent=c=>{console.error("信令服务器连接错误:",c)},this.cli.handleCloseEvent=()=>{console.log("与信令服务器的连接已断开")}}destroy(){this.cli.close(),this.pc?.close()}sendSignalingMessage(t){this.cli.send(JSON.stringify(t))}initializePeerConnection(){const t={iceServers:[{urls:"stun:stun.miwifi.com"}]};this.pc=new RTCPeerConnection(t),this.pc.onicecandidate=e=>{e.candidate&&(console.log("发送本地 ICE candidate:",e.candidate),this.sendSignalingMessage({id:this.id,candidate:e.candidate}))},this.pc.ondatachannel=e=>{console.log("收到远程数据通道"),this.dataChannel=e.channel,this.setupDataChannel()},this.pc.oniceconnectionstatechange=()=>{console.log("ICE 连接状态:",this.pc?.iceConnectionState),this.pc?.iceConnectionState==="failed"&&console.error("ICE 连接失败。")},this.pc.onconnectionstatechange=()=>{console.log("Connection 状态:",this.pc?.connectionState),this.onConnState(this.pc?.connectionState)},this.pc.ontrack=e=>{for(const n of e.streams)this.onStream(n);console.log("收到远程媒体流",e.streams.length)},this.pc.onnegotiationneeded=async()=>{console.log("🧠 触发 renegotiation"),this.peerId&&this.renegotiate(this.peerId)}}async createOffer(t){if(this.pc){this.peerId=t,console.log("创建 Offer..."),this.dataChannel=this.pc.createDataChannel("messageChannel"),this.setupDataChannel();try{const e=await this.pc.createOffer();await this.pc.setLocalDescription(e),console.log("发送本地 Offer:",e),this.sendSignalingMessage({id:this.id,offer:{desc:e,peerId:t}})}catch(e){console.error("创建 Offer 时出错:",e)}}}async receiveOffer(t,e){if(this.pc){this.peerId=t,console.log("收到 Offer, 创建 Answer...");try{await this.pc.setRemoteDescription(new RTCSessionDescription(e));const n=await this.pc.createAnswer();await this.pc.setLocalDescription(n),console.log("发送本地 Answer:",n),this.sendSignalingMessage({id:this.id,answer:n})}catch(n){console.error("处理 Offer 时出错:",n)}}}async receiveAnswer(t){if(this.pc){console.log("收到 Answer");try{await this.pc.setRemoteDescription(new RTCSessionDescription(t))}catch(e){console.error("处理 Answer 时出错:",e)}}}async addIceCandidate(t){if(this.pc){console.log("添加远程 ICE Candidate");try{await this.pc.addIceCandidate(new RTCIceCandidate(t))}catch(e){console.error("添加 ICE candidate 时出错:",e)}}}setupDataChannel(){this.dataChannel&&(this.dataChannel.bufferedAmountLowThreshold=ce,this.dataChannel.onopen=()=>{console.log("数据通道已打开"),this.sendMessage(`hello from ${this.id}`)},this.dataChannel.onclose=()=>{console.log("数据通道已关闭")},this.dataChannel.onerror=t=>{console.error("数据通道错误:",t)},this.dataChannel.onmessage=t=>{console.log("收到消息:",typeof t.data),this.onMessage(t.data)},this.dataChannel.onbufferedamountlow=()=>{console.log("数据通道缓冲区已空闲");const t=this.writable;this.writable=void 0,t?.()})}writable;sendMessage(t){this.dataChannel&&this.dataChannel.readyState==="open"?(this.dataChannel.send(JSON.stringify(t)),console.log("已发送消息:",t)):console.warn("数据通道未打开，无法发送消息。当前状态:",this.dataChannel?.readyState)}async sendData(t){if(this.writable)throw new Error("wait until writable");if(this.dataChannel&&this.dataChannel.readyState==="open"){if(this.dataChannel.bufferedAmount>ae){await new Promise(e=>{this.writable=e}),this.sendData(t);return}try{this.dataChannel.send(t)}catch(e){console.error("发送数据时出错:",e)}}else console.warn("数据通道未打开，无法发送消息。当前状态:",this.dataChannel?.readyState)}addTrack(t,e){return this.pc?.addTrack(t,e)}removeTrack(t){try{return this.pc?.removeTrack(t)}catch(e){console.error("Failed to remove track:",e)}}async renegotiate(t){if(this.pc){console.log("重新协商 Offer...");try{const e=await this.pc.createOffer();await this.pc.setLocalDescription(e),console.log("发送本地 Offer:",e),this.sendSignalingMessage({id:this.id,offer:{desc:e,peerId:t}})}catch(e){console.error("创建 Offer 时出错:",e)}}}}function he(s,t=1024*1024){const e=[];for(let n=0;n<s.size;n+=t)e.push(s.slice(n,n+t));return e}async function fe(s){const e=await(await window.showSaveFilePicker({suggestedName:s})).createWritable();return[async o=>{await e.write(o)},()=>{e.close()},e]}var ue=g("<button>视频语音"),ge=g("<dialog style=width:50vw;height:50vh;><button>Video: </button><button>Audio: </button><button>Mute</button><button>关闭</button><hr><video autoplay playsinline style=width:128px;height:96px;></video><video autoplay playsinline muted style=width:64px;height:48px;>");function pe(s){let t=null,e=null,n=null,i=new MediaStream,o=null,c=null,r,C;const[M,O]=w(!1),[x,_]=w(!1),D=p=>{n!==null&&(n.srcObject=p)},I=(()=>{var p=ue();return p.$$click=()=>{t?.showModal()},p})();return[(()=>{var p=ge(),S=p.firstChild;S.firstChild;var $=S.nextSibling;$.firstChild;var a=$.nextSibling,d=a.nextSibling,u=d.nextSibling,v=u.nextSibling,b=v.nextSibling;return A(m=>t=m,p),S.$$click=async()=>{e!==null&&(o?(r&&(s.removeTrack(r),r=void 0),i.removeTrack(o),o.stop(),o=null,console.log("📹 Video track removed"),e.srcObject=null,O(!1)):(o=(await navigator.mediaDevices.getUserMedia(me)).getVideoTracks()[0],i.addTrack(o),r=s.addTrack(o,i),console.log("📹 Video track added"),e.srcObject=i,O(!0)))},f(S,()=>M()?"ON":"OFF",null),$.$$click=async()=>{e!==null&&(c?(C&&(s.removeTrack(C),C=void 0),i.removeTrack(c),c.stop(),c=null,console.log("📹 Audio track removed"),e.srcObject=null,_(!1)):(c=(await navigator.mediaDevices.getUserMedia(ve)).getAudioTracks()[0],i.addTrack(c),C=s.addTrack(c,i),console.log("📹 Audio track added"),e.srcObject=i,_(!0)))},f($,()=>x()?"ON":"OFF",null),a.$$click=()=>{e&&(e.muted=!e.muted)},d.$$click=()=>t?.close(),A(m=>n=m,v),A(m=>e=m,b),T(()=>d.disabled=M()||x()),p})(),I,D]}const me={video:{width:160,height:120,frameRate:{ideal:10,max:15}}},ve={audio:{bitrate:{ideal:48e3},channelCount:{ideal:1},echoCancellation:!0}};H(["click"]);var we=g("<label for=peer_ids>Peer ID List: "),Ce=g("<select id=peer_ids style=width:320px;><option value>========== 请选择 Peer ID ==========="),be=g("<button>发送 Offer"),Se=g('<div><p><button>广播 ID</button></p><div class=flex><div class=flex-1><div><textarea id=text rows=3></textarea></div><p><button>发送</button></p></div><div class=flex-1><div><input id=file type=file placeholder=文件></div><p></p></div></div><p>Id: <mark></mark>, State: <b><i></i></b></p><p>Message:</p><div class="break font">'),$e=g("<option>"),ye=g("<button>Reload"),_e=g("<button>接收并保存"),ke=g("<br>"),Me=g("<i class=font>文件：<!>，区块：<!>，已接收：");const Oe=new URLSearchParams(window.location.search).has("master"),xe=()=>{const s=new de({onConnState(a){a==="cli_connected"?(P(!0),s.sendSignalingMessage({type:"PeerID",id:s.id})):a==="cli_disconnected"?P(!1):r(a)},async onMessage(a){if(typeof a=="string"){const d=JSON.parse(a);if(d.file){if(d.file.type==="showSaveFilePicker")U(d.file);else if(d.file.type==="beginRecieve"&&n)for(const u of n)await s.sendData(u)}_(a)}else if(a instanceof ArrayBuffer&&e){const d=F();d?.type;const[u,v]=e;u(a);const b=J()+1;B(b),d?.chunks===b&&(v(),U(void 0),alert("文件保存成功")),console.log("receivedChunk",b)}else console.log("onMessage",a)},onPeerID(a){o(d=>{const u=d.filter(v=>v!==a);return u.unshift(a),u})},onStream(a){$(a)}});ne(()=>{console.log("App mounted")}),ie(()=>{console.log("App onCleanup"),s.destroy()});let t="",e=null,n=null;const[i,o]=w([]),[c,r]=w(),[C,M]=w(""),[O,x]=w([]),_=a=>{x(d=>(d.unshift(a),d.slice(0,30)))},D=se(()=>c()==="connected"),[I,P]=w(!1),[p,S,$]=pe(s);return(()=>{var a=Se(),d=a.firstChild,u=d.firstChild,v=d.nextSibling,b=v.firstChild,m=b.firstChild,R=m.firstChild,q=m.nextSibling,L=q.firstChild,z=b.nextSibling,E=z.firstChild,N=E.firstChild,Q=E.nextSibling,W=v.nextSibling,K=W.firstChild,j=K.nextSibling,X=j.nextSibling,G=X.nextSibling,Y=G.firstChild,Z=W.nextSibling,ee=Z.nextSibling;return u.$$click=()=>s.sendSignalingMessage({id:s.id,type:"PeerID"}),f(d,k(V,{get when(){return i().length>0},get children(){return[we(),(()=>{var l=Ce();return l.firstChild,l.addEventListener("change",h=>{console.log("select peer id",h.target.value),t=h.target.value}),f(l,k(oe,{get each(){return i()},children:h=>(()=>{var y=$e();return y.value=h,f(y,h),y})()}),null),l})(),(()=>{var l=be();return l.$$click=()=>{t?s.createOffer(t):alert("请选择 Peer ID")},T(()=>l.disabled=!I()),l})()]}}),null),f(d,Oe&&(()=>{var l=ye();return l.$$click=()=>{s.sendSignalingMessage({type:"Reload",id:s.id})},l})(),null),R.addEventListener("focus",l=>l.target.select()),R.addEventListener("change",l=>M(l.target.value)),L.$$click=()=>{_("me: "+C()),s.sendMessage(C())},f(E,()=>D()&&S,N),N.addEventListener("change",async l=>{const h=l.target.files?.[0];h!==void 0&&(console.log("文件选择",h),l.target.value="",n=he(h,32*1024),console.log("分块",n),s.sendMessage({file:{type:"showSaveFilePicker",name:h.name,chunks:n.length}}))}),f(Q,k(De,{onFileWriter:l=>{e=l;const h=F();h&&(B(0),s.sendMessage({file:{...h,type:"beginRecieve"}}))}})),f(j,()=>s.id),f(Y,()=>c()??"unknown"),f(ee,()=>O().join(`
`)),f(a,p,null),T(l=>{var h=!I(),y=D()===!1;return h!==l.e&&(u.disabled=l.e=h),y!==l.t&&(L.disabled=l.t=y),l},{e:void 0,t:void 0}),T(()=>R.value=C()),a})()},[F,U]=w(),[J,B]=w(0);function De(s){return k(V,{get when(){return F()},keyed:!0,children:t=>[(()=>{var e=_e();return e.$$click=async()=>{const n=await fe(t.name);s.onFileWriter(n)},e})(),ke(),(()=>{var e=Me(),n=e.firstChild,i=n.nextSibling,o=i.nextSibling,c=o.nextSibling;return c.nextSibling,f(e,()=>t?.name,i),f(e,()=>t.chunks,c),f(e,J,null),e})()]})}H(["click"]);const Ie=document.getElementById("root");le(()=>k(xe,{}),Ie);
