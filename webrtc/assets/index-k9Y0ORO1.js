import{M as te,d as H,c as m,t as v,u as F,i as u,a as M,o as ne,b as ie,e as se,f as _,F as oe,S as J,r as re}from"./vendor-CfKRxhm_.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function e(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(i){if(i.ep)return;i.ep=!0;const s=e(i);fetch(i.href,s)}})();class le{client;topic;constructor({url:t,topic:e}){this.topic=e,this.client=te.connect(t,{reconnectPeriod:5e3})}set handleConnectEvent(t){const{client:e,topic:n}=this;e.on("connect",()=>{e.subscribe(n,i=>{i?console.error("Subscribe error:",i):(console.log(`Subscribed to topic: ${n}`),t())})})}set handleMessageEvent(t){const{client:e,topic:n}=this;e.on("message",(i,s)=>{const a=s.toString();console.log(`Received message on topic ${i}`),i===n&&t(a)})}set handleErrorEvent(t){const{client:e}=this;e.on("error",n=>{t(n)})}set handleCloseEvent(t){const{client:e}=this;e.on("close",()=>{t()})}send(t){const{client:e,topic:n}=this;e.publish(n,t,i=>{i?console.error("Publish error:",i):console.log(`Published message to topic: ${n}`)})}close(){this.client.end()}}const ae=8*1024*1024,ce=1*1024*1024;class de{pc=null;dataChannel=null;cli;id=crypto.randomUUID();peerId;onMessage;onConnState;onPeerID;onStream;constructor({onMessage:t,onConnState:e,onPeerID:n,onStream:i}){console.log("åˆå§‹åŒ– WebRTCDemo",this.id);const s="wss://test.mosquitto.org:8081";this.cli=new le({url:s,topic:"test/webrtc/topic"}),this.onMessage=t,this.onConnState=e,this.onPeerID=n,this.onStream=i,this.cli.handleConnectEvent=()=>{console.log("æˆåŠŸè¿æ¥åˆ°ä¿¡ä»¤æœåŠ¡å™¨"),this.initializePeerConnection(),this.onConnState("cli_connected")},this.cli.handleMessageEvent=async a=>{const c=JSON.parse(a);if(c.id!==this.id)if(console.log("ä»ä¿¡ä»¤æœåŠ¡å™¨æ”¶åˆ°æ¶ˆæ¯:",c),c.type==="PeerID")this.onPeerID(c.id);else if(c.offer){if(c.offer.peerId!==this.id)return;await this.receiveOffer(c.id,c.offer.desc)}else c.answer?await this.receiveAnswer(c.answer):c.candidate&&await this.addIceCandidate(c.candidate)},this.cli.handleErrorEvent=a=>{console.error("ä¿¡ä»¤æœåŠ¡å™¨è¿æ¥é”™è¯¯:",a)},this.cli.handleCloseEvent=()=>{console.log("ä¸ä¿¡ä»¤æœåŠ¡å™¨çš„è¿æ¥å·²æ–­å¼€")}}destroy(){this.cli.close(),this.pc?.close()}sendSignalingMessage(t){this.cli.send(JSON.stringify(t))}initializePeerConnection(){const t={iceServers:[{urls:"stun:stun.miwifi.com"}]};this.pc=new RTCPeerConnection(t),this.pc.onicecandidate=e=>{e.candidate&&(console.log("å‘é€æœ¬åœ° ICE candidate:",e.candidate),this.sendSignalingMessage({id:this.id,candidate:e.candidate}))},this.pc.ondatachannel=e=>{console.log("æ”¶åˆ°è¿œç¨‹æ•°æ®é€šé“"),this.dataChannel=e.channel,this.setupDataChannel()},this.pc.oniceconnectionstatechange=()=>{console.log("ICE è¿æ¥çŠ¶æ€:",this.pc?.iceConnectionState),this.pc?.iceConnectionState==="failed"&&console.error("ICE è¿æ¥å¤±è´¥ã€‚")},this.pc.onconnectionstatechange=()=>{console.log("Connection çŠ¶æ€:",this.pc?.connectionState),this.onConnState(this.pc?.connectionState)},this.pc.ontrack=e=>{for(const n of e.streams)this.onStream(n);console.log("æ”¶åˆ°è¿œç¨‹åª’ä½“æµ",e.streams.length)},this.pc.onnegotiationneeded=async()=>{console.log("ğŸ§  è§¦å‘ renegotiation"),this.peerId&&this.renegotiate(this.peerId)}}async createOffer(t){if(this.pc){this.peerId=t,console.log("åˆ›å»º Offer..."),this.dataChannel=this.pc.createDataChannel("messageChannel"),this.setupDataChannel();try{const e=await this.pc.createOffer();await this.pc.setLocalDescription(e),console.log("å‘é€æœ¬åœ° Offer:",e),this.sendSignalingMessage({id:this.id,offer:{desc:e,peerId:t}})}catch(e){console.error("åˆ›å»º Offer æ—¶å‡ºé”™:",e)}}}async receiveOffer(t,e){if(this.pc){this.peerId=t,console.log("æ”¶åˆ° Offer, åˆ›å»º Answer...");try{await this.pc.setRemoteDescription(new RTCSessionDescription(e));const n=await this.pc.createAnswer();await this.pc.setLocalDescription(n),console.log("å‘é€æœ¬åœ° Answer:",n),this.sendSignalingMessage({id:this.id,answer:n})}catch(n){console.error("å¤„ç† Offer æ—¶å‡ºé”™:",n)}}}async receiveAnswer(t){if(this.pc){console.log("æ”¶åˆ° Answer");try{await this.pc.setRemoteDescription(new RTCSessionDescription(t))}catch(e){console.error("å¤„ç† Answer æ—¶å‡ºé”™:",e)}}}async addIceCandidate(t){if(this.pc){console.log("æ·»åŠ è¿œç¨‹ ICE Candidate");try{await this.pc.addIceCandidate(new RTCIceCandidate(t))}catch(e){console.error("æ·»åŠ  ICE candidate æ—¶å‡ºé”™:",e)}}}setupDataChannel(){this.dataChannel&&(this.dataChannel.bufferedAmountLowThreshold=ce,this.dataChannel.onopen=()=>{console.log("æ•°æ®é€šé“å·²æ‰“å¼€"),this.sendMessage(`hello from ${this.id}`)},this.dataChannel.onclose=()=>{console.log("æ•°æ®é€šé“å·²å…³é—­")},this.dataChannel.onerror=t=>{console.error("æ•°æ®é€šé“é”™è¯¯:",t)},this.dataChannel.onmessage=t=>{console.log("æ”¶åˆ°æ¶ˆæ¯:",typeof t.data),this.onMessage(t.data)},this.dataChannel.onbufferedamountlow=()=>{console.log("æ•°æ®é€šé“ç¼“å†²åŒºå·²ç©ºé—²");const t=this.writable;this.writable=void 0,t?.()})}writable;sendMessage(t){this.dataChannel&&this.dataChannel.readyState==="open"?(this.dataChannel.send(JSON.stringify(t)),console.log("å·²å‘é€æ¶ˆæ¯:",t)):console.warn("æ•°æ®é€šé“æœªæ‰“å¼€ï¼Œæ— æ³•å‘é€æ¶ˆæ¯ã€‚å½“å‰çŠ¶æ€:",this.dataChannel?.readyState)}async sendData(t){if(this.writable)throw new Error("wait until writable");if(this.dataChannel&&this.dataChannel.readyState==="open"){if(this.dataChannel.bufferedAmount>ae){await new Promise(e=>{this.writable=e}),this.sendData(t);return}try{this.dataChannel.send(t)}catch(e){console.error("å‘é€æ•°æ®æ—¶å‡ºé”™:",e)}}else console.warn("æ•°æ®é€šé“æœªæ‰“å¼€ï¼Œæ— æ³•å‘é€æ¶ˆæ¯ã€‚å½“å‰çŠ¶æ€:",this.dataChannel?.readyState)}signal(t){this.cli.send(JSON.stringify(t))}addTrack(t,e){return this.pc?.addTrack(t,e)}removeTrack(t){return this.pc?.removeTrack(t)}async renegotiate(t){if(this.pc){console.log("é‡æ–°åå•† Offer...");try{const e=await this.pc.createOffer();await this.pc.setLocalDescription(e),console.log("å‘é€æœ¬åœ° Offer:",e),this.sendSignalingMessage({id:this.id,offer:{desc:e,peerId:t}})}catch(e){console.error("åˆ›å»º Offer æ—¶å‡ºé”™:",e)}}}}function he(o,t=1024*1024){const e=[];for(let n=0;n<o.size;n+=t)e.push(o.slice(n,n+t));return e}async function fe(o){const e=await(await window.showSaveFilePicker({suggestedName:o})).createWritable();return[async s=>{await e.write(s)},()=>{e.close()},e]}var ue=v("<button>Media"),ge=v("<dialog style=width:50vw;height:50vh;><button>Video: </button><button>Audio: </button><button>å…³é—­</button><hr><video autoplay playsinline style=width:128px;height:96px;></video><video autoplay playsinline style=width:64px;height:48px;>");function pe(o){let t=null,e=null,n=null,i=new MediaStream,s=null,a=null,c;const[$,k]=m(!1),[O,D]=m(!1),x=g=>{n!==null&&(n.srcObject=g)},I=(()=>{var g=ue();return g.$$click=()=>{t?.showModal()},g})();return[(()=>{var g=ge(),C=g.firstChild;C.firstChild;var w=C.nextSibling;w.firstChild;var y=w.nextSibling,r=y.nextSibling,d=r.nextSibling,p=d.nextSibling;return F(f=>t=f,g),C.$$click=async()=>{e!==null&&(s?(c&&(o.removeTrack(c),c=void 0),i.removeTrack(s),s.stop(),s=null,console.log("ğŸ“¹ Video track removed"),e.srcObject=null,k(!1)):(s=(await navigator.mediaDevices.getUserMedia({video:!0})).getVideoTracks()[0],i.addTrack(s),c=o.addTrack(s,i),console.log("ğŸ“¹ Video track added"),e.srcObject=i,k(!0)))},u(C,()=>$()?"ON":"OFF",null),w.$$click=async()=>{e!==null&&(a?(i.removeTrack(a),a.stop(),a=null,console.log("ğŸ“¹ Video track removed"),e.srcObject=null,D(!1)):(a=(await navigator.mediaDevices.getUserMedia({audio:!0})).getAudioTracks()[0],i.addTrack(a),console.log("ğŸ“¹ Video track added"),e.srcObject=i,D(!0)))},u(w,()=>O()?"ON":"OFF",null),y.$$click=()=>t?.close(),F(f=>n=f,d),F(f=>e=f,p),M(()=>y.disabled=$()||O()),g})(),I,x]}H(["click"]);var ve=v("<label for=peer_ids>Peer ID List: "),me=v("<select id=peer_ids style=width:320px;><option value>========== è¯·é€‰æ‹© Peer ID ==========="),Ce=v("<button>å‘é€ Offer"),we=v('<div><p><button>å¹¿æ’­ ID</button></p><div class=flex><div class=flex-1><div><textarea id=text rows=3></textarea></div><p><button>å‘é€</button></p></div><div class=flex-1><div><input id=file type=file placeholder=æ–‡ä»¶></div><p></p></div></div><p>Id: <mark></mark>, State: <b><i></i></b></p><p>Message:</p><div class="break font">'),be=v("<option>"),Se=v("<button>æ¥æ”¶å¹¶ä¿å­˜"),$e=v("<br>"),ye=v("<i class=font>æ–‡ä»¶ï¼š<!>ï¼ŒåŒºå—ï¼š<!>ï¼Œå·²æ¥æ”¶ï¼š");const _e=()=>{const o=new de({onConnState(r){r==="cli_connected"?g(!0):r==="cli_disconnected"?g(!1):c(r)},async onMessage(r){if(typeof r=="string"){const d=JSON.parse(r);if(d.file){if(d.file.type==="showSaveFilePicker")j(d.file);else if(d.file.type==="beginRecieve"&&n)for(const p of n)await o.sendData(p)}x(r)}else if(r instanceof ArrayBuffer&&e){const d=A();d?.type;const[p,f]=e;p(r);const b=U()+1;B(b),d?.chunks===b&&(f(),j(void 0),alert("æ–‡ä»¶ä¿å­˜æˆåŠŸ")),console.log("receivedChunk",b)}else console.log("onMessage",r)},onPeerID(r){s(d=>{const p=d.filter(f=>f!==r);return p.unshift(r),p})},onStream(r){y(r)}});ne(()=>{console.log("App mounted")}),ie(()=>{console.log("App onCleanup"),o.destroy()});let t="",e=null,n=null;const[i,s]=m([]),[a,c]=m(),[$,k]=m(""),[O,D]=m(""),x=r=>{D(d=>r+`
`+d)},I=se(()=>a()==="connected"),[T,g]=m(!1),[C,w,y]=pe(o);return(()=>{var r=we(),d=r.firstChild,p=d.firstChild,f=d.nextSibling,b=f.firstChild,R=b.firstChild,E=R.firstChild,q=R.nextSibling,L=q.firstChild,z=b.nextSibling,P=z.firstChild,N=P.firstChild,Q=P.nextSibling,W=f.nextSibling,K=W.firstChild,V=K.nextSibling,X=V.nextSibling,G=X.nextSibling,Y=G.firstChild,Z=W.nextSibling,ee=Z.nextSibling;return p.$$click=()=>o.signal({id:o.id,type:"PeerID"}),u(d,_(J,{get when(){return i().length>0},get children(){return[ve(),(()=>{var l=me();return l.firstChild,l.addEventListener("change",h=>{console.log("select peer id",h.target.value),t=h.target.value}),u(l,_(oe,{get each(){return i()},children:h=>(()=>{var S=be();return S.value=h,u(S,h),S})()}),null),l})(),(()=>{var l=Ce();return l.$$click=()=>{t?o.createOffer(t):alert("è¯·é€‰æ‹© Peer ID")},M(()=>l.disabled=!T()),l})()]}}),null),E.addEventListener("focus",l=>l.target.select()),E.addEventListener("change",l=>k(l.target.value)),L.$$click=()=>{o.sendMessage($())},u(P,w,N),N.addEventListener("change",async l=>{const h=l.target.files?.[0];h!==void 0&&(console.log("æ–‡ä»¶é€‰æ‹©",h),l.target.value="",n=he(h,32*1024),console.log("åˆ†å—",n),o.sendMessage({file:{type:"showSaveFilePicker",name:h.name,chunks:n.length}}))}),u(Q,_(ke,{onFileWriter:l=>{e=l;const h=A();h&&(B(0),o.sendMessage({file:{...h,type:"beginRecieve"}}))}})),u(V,()=>o.id),u(Y,()=>a()??"unknown"),u(ee,O),u(r,C,null),M(l=>{var h=!T(),S=I()===!1;return h!==l.e&&(p.disabled=l.e=h),S!==l.t&&(L.disabled=l.t=S),l},{e:void 0,t:void 0}),M(()=>E.value=$()),r})()},[A,j]=m(),[U,B]=m(0);function ke(o){return _(J,{get when(){return A()},keyed:!0,children:t=>[(()=>{var e=Se();return e.$$click=async()=>{const n=await fe(t.name);o.onFileWriter(n)},e})(),$e(),(()=>{var e=ye(),n=e.firstChild,i=n.nextSibling,s=i.nextSibling,a=s.nextSibling;return a.nextSibling,u(e,()=>t?.name,i),u(e,()=>t.chunks,a),u(e,U,null),e})()]})}H(["click"]);const Oe=document.getElementById("root");re(()=>_(_e,{}),Oe);
