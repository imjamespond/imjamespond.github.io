import{M as te,d as H,c as m,t as v,u as R,i as u,a as M,o as ne,b as ie,e as se,f as y,F as oe,S as J,r as le}from"./vendor-CfKRxhm_.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function e(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(i){if(i.ep)return;i.ep=!0;const s=e(i);fetch(i.href,s)}})();class re{client;topic;constructor({url:t,topic:e}){this.topic=e,this.client=te.connect(t,{reconnectPeriod:5e3})}set handleConnectEvent(t){const{client:e,topic:n}=this;e.on("connect",()=>{e.subscribe(n,i=>{i?console.error("Subscribe error:",i):(console.log(`Subscribed to topic: ${n}`),t())})})}set handleMessageEvent(t){const{client:e,topic:n}=this;e.on("message",(i,s)=>{const a=s.toString();console.log(`Received message on topic ${i}`),i===n&&t(a)})}set handleErrorEvent(t){const{client:e}=this;e.on("error",n=>{t(n)})}set handleCloseEvent(t){const{client:e}=this;e.on("close",()=>{t()})}send(t){const{client:e,topic:n}=this;e.publish(n,t,i=>{i?console.error("Publish error:",i):console.log(`Published message to topic: ${n}`)})}close(){this.client.end()}}const ae=8*1024*1024,ce=1*1024*1024;class de{pc=null;dataChannel=null;cli;id=crypto.randomUUID();peerId;onMessage;onConnState;onPeerID;onStream;constructor({onMessage:t,onConnState:e,onPeerID:n,onStream:i}){console.log("初始化 WebRTCDemo",this.id);const s="wss://test.mosquitto.org:8081";this.cli=new re({url:s,topic:"test/webrtc/topic"}),this.onMessage=t,this.onConnState=e,this.onPeerID=n,this.onStream=i,this.cli.handleConnectEvent=()=>{console.log("成功连接到信令服务器"),this.initializePeerConnection(),this.onConnState("cli_connected")},this.cli.handleMessageEvent=async a=>{const c=JSON.parse(a);if(c.id!==this.id)if(console.log("从信令服务器收到消息:",c),c.type==="PeerID")this.onPeerID(c.id);else if(c.offer){if(c.offer.peerId!==this.id)return;await this.receiveOffer(c.id,c.offer.desc)}else c.answer?await this.receiveAnswer(c.answer):c.candidate&&await this.addIceCandidate(c.candidate)},this.cli.handleErrorEvent=a=>{console.error("信令服务器连接错误:",a)},this.cli.handleCloseEvent=()=>{console.log("与信令服务器的连接已断开")}}destroy(){this.cli.close(),this.pc?.close()}sendSignalingMessage(t){this.cli.send(JSON.stringify(t))}initializePeerConnection(){const t={iceServers:[{urls:"stun:stun.miwifi.com"}]};this.pc=new RTCPeerConnection(t),this.pc.onicecandidate=e=>{e.candidate&&(console.log("发送本地 ICE candidate:",e.candidate),this.sendSignalingMessage({id:this.id,candidate:e.candidate}))},this.pc.ondatachannel=e=>{console.log("收到远程数据通道"),this.dataChannel=e.channel,this.setupDataChannel()},this.pc.oniceconnectionstatechange=()=>{console.log("ICE 连接状态:",this.pc?.iceConnectionState),this.pc?.iceConnectionState==="failed"&&console.error("ICE 连接失败。")},this.pc.onconnectionstatechange=()=>{console.log("Connection 状态:",this.pc?.connectionState),this.onConnState(this.pc?.connectionState)},this.pc.ontrack=e=>{for(const n of e.streams)this.onStream(n);console.log("收到远程媒体流",e.streams.length)},this.pc.onnegotiationneeded=async()=>{console.log("🧠 触发 renegotiation"),this.peerId&&this.renegotiate(this.peerId)}}async createOffer(t){if(this.pc){this.peerId=t,console.log("创建 Offer..."),this.dataChannel=this.pc.createDataChannel("messageChannel"),this.setupDataChannel();try{const e=await this.pc.createOffer();await this.pc.setLocalDescription(e),console.log("发送本地 Offer:",e),this.sendSignalingMessage({id:this.id,offer:{desc:e,peerId:t}})}catch(e){console.error("创建 Offer 时出错:",e)}}}async receiveOffer(t,e){if(this.pc){this.peerId=t,console.log("收到 Offer, 创建 Answer...");try{await this.pc.setRemoteDescription(new RTCSessionDescription(e));const n=await this.pc.createAnswer();await this.pc.setLocalDescription(n),console.log("发送本地 Answer:",n),this.sendSignalingMessage({id:this.id,answer:n})}catch(n){console.error("处理 Offer 时出错:",n)}}}async receiveAnswer(t){if(this.pc){console.log("收到 Answer");try{await this.pc.setRemoteDescription(new RTCSessionDescription(t))}catch(e){console.error("处理 Answer 时出错:",e)}}}async addIceCandidate(t){if(this.pc){console.log("添加远程 ICE Candidate");try{await this.pc.addIceCandidate(new RTCIceCandidate(t))}catch(e){console.error("添加 ICE candidate 时出错:",e)}}}setupDataChannel(){this.dataChannel&&(this.dataChannel.bufferedAmountLowThreshold=ce,this.dataChannel.onopen=()=>{console.log("数据通道已打开"),this.sendMessage(`hello from ${this.id}`)},this.dataChannel.onclose=()=>{console.log("数据通道已关闭")},this.dataChannel.onerror=t=>{console.error("数据通道错误:",t)},this.dataChannel.onmessage=t=>{console.log("收到消息:",typeof t.data),this.onMessage(t.data)},this.dataChannel.onbufferedamountlow=()=>{console.log("数据通道缓冲区已空闲");const t=this.writable;this.writable=void 0,t?.()})}writable;sendMessage(t){this.dataChannel&&this.dataChannel.readyState==="open"?(this.dataChannel.send(JSON.stringify(t)),console.log("已发送消息:",t)):console.warn("数据通道未打开，无法发送消息。当前状态:",this.dataChannel?.readyState)}async sendData(t){if(this.writable)throw new Error("wait until writable");if(this.dataChannel&&this.dataChannel.readyState==="open"){if(this.dataChannel.bufferedAmount>ae){await new Promise(e=>{this.writable=e}),this.sendData(t);return}try{this.dataChannel.send(t)}catch(e){console.error("发送数据时出错:",e)}}else console.warn("数据通道未打开，无法发送消息。当前状态:",this.dataChannel?.readyState)}signal(t){this.cli.send(JSON.stringify(t))}addTrack(t,e){return this.pc?.addTrack(t,e)}removeTrack(t){return this.pc?.removeTrack(t)}async renegotiate(t){if(this.pc){console.log("重新协商 Offer...");try{const e=await this.pc.createOffer();await this.pc.setLocalDescription(e),console.log("发送本地 Offer:",e),this.sendSignalingMessage({id:this.id,offer:{desc:e,peerId:t}})}catch(e){console.error("创建 Offer 时出错:",e)}}}}function he(l,t=1024*1024){const e=[];for(let n=0;n<l.size;n+=t)e.push(l.slice(n,n+t));return e}async function fe(l){const e=await(await window.showSaveFilePicker({suggestedName:l})).createWritable();return[async s=>{await e.write(s)},()=>{e.close()},e]}var ue=v("<button>语音"),ge=v("<dialog style=width:50vw;height:50vh;><button>Video: </button><button>Audio: </button><button>Mute</button><button>关闭</button><hr><video autoplay playsinline style=width:128px;height:96px;></video><video autoplay playsinline muted style=width:64px;height:48px;>");function pe(l){let t=null,e=null,n=null,i=new MediaStream,s=null,a=null,c;const[S,_]=m(!1),[k,O]=m(!1),I=p=>{n!==null&&(n.srcObject=p)},T=(()=>{var p=ue();return p.$$click=()=>{t?.showModal()},p})();return[(()=>{var p=ge(),w=p.firstChild;w.firstChild;var b=w.nextSibling;b.firstChild;var x=b.nextSibling,o=x.nextSibling,d=o.nextSibling,g=d.nextSibling,C=g.nextSibling;return R(f=>t=f,p),w.$$click=async()=>{if(e!==null)if(s)c&&(l.removeTrack(c),c=void 0),i.removeTrack(s),s.stop(),s=null,console.log("📹 Video track removed"),e.srcObject=null,_(!1);else{s=(await navigator.mediaDevices.getUserMedia({video:{width:{min:320,ideal:640,max:640},height:{min:240,ideal:480,max:480}}})).getVideoTracks()[0];try{await s.applyConstraints(ve),console.log("Video constraints applied successfully.")}catch(D){console.error("Failed to apply video constraints:",D)}i.addTrack(s),c=l.addTrack(s,i),console.log("📹 Video track added"),e.srcObject=i,_(!0)}},u(w,()=>S()?"ON":"OFF",null),b.$$click=async()=>{e!==null&&(a?(i.removeTrack(a),a.stop(),a=null,console.log("📹 Video track removed"),e.srcObject=null,O(!1)):(a=(await navigator.mediaDevices.getUserMedia(me)).getAudioTracks()[0],i.addTrack(a),console.log("📹 Video track added"),e.srcObject=i,O(!0)))},u(b,()=>k()?"ON":"OFF",null),x.$$click=()=>{e&&(e.muted=!e.muted)},o.$$click=()=>t?.close(),R(f=>n=f,g),R(f=>e=f,C),M(()=>o.disabled=S()||k()),p})(),T,I]}const ve={advanced:[{frameRate:{ideal:10}}]},me={audio:{bitrate:{ideal:48e3},channelCount:{ideal:1},echoCancellation:!0}};H(["click"]);var Ce=v("<label for=peer_ids>Peer ID List: "),we=v("<select id=peer_ids style=width:320px;><option value>========== 请选择 Peer ID ==========="),be=v("<button>发送 Offer"),$e=v('<div><p><button>广播 ID</button></p><div class=flex><div class=flex-1><div><textarea id=text rows=3></textarea></div><p><button>发送</button></p></div><div class=flex-1><div><input id=file type=file placeholder=文件></div><p></p></div></div><p>Id: <mark></mark>, State: <b><i></i></b></p><p>Message:</p><div class="break font">'),Se=v("<option>"),ye=v("<button>接收并保存"),_e=v("<br>"),ke=v("<i class=font>文件：<!>，区块：<!>，已接收：");const Oe=()=>{const l=new de({onConnState(o){o==="cli_connected"?p(!0):o==="cli_disconnected"?p(!1):c(o)},async onMessage(o){if(typeof o=="string"){const d=JSON.parse(o);if(d.file){if(d.file.type==="showSaveFilePicker")j(d.file);else if(d.file.type==="beginRecieve"&&n)for(const g of n)await l.sendData(g)}I(o)}else if(o instanceof ArrayBuffer&&e){const d=A();d?.type;const[g,C]=e;g(o);const f=U()+1;B(f),d?.chunks===f&&(C(),j(void 0),alert("文件保存成功")),console.log("receivedChunk",f)}else console.log("onMessage",o)},onPeerID(o){s(d=>{const g=d.filter(C=>C!==o);return g.unshift(o),g})},onStream(o){x(o)}});ne(()=>{console.log("App mounted")}),ie(()=>{console.log("App onCleanup"),l.destroy()});let t="",e=null,n=null;const[i,s]=m([]),[a,c]=m(),[S,_]=m(""),[k,O]=m(""),I=o=>{O(d=>o+`
`+d)},T=se(()=>a()==="connected"),[E,p]=m(!1),[w,b,x]=pe(l);return(()=>{var o=$e(),d=o.firstChild,g=d.firstChild,C=d.nextSibling,f=C.firstChild,D=f.firstChild,P=D.firstChild,q=D.nextSibling,L=q.firstChild,z=f.nextSibling,F=z.firstChild,N=F.firstChild,Q=F.nextSibling,V=C.nextSibling,K=V.firstChild,W=K.nextSibling,X=W.nextSibling,G=X.nextSibling,Y=G.firstChild,Z=V.nextSibling,ee=Z.nextSibling;return g.$$click=()=>l.signal({id:l.id,type:"PeerID"}),u(d,y(J,{get when(){return i().length>0},get children(){return[Ce(),(()=>{var r=we();return r.firstChild,r.addEventListener("change",h=>{console.log("select peer id",h.target.value),t=h.target.value}),u(r,y(oe,{get each(){return i()},children:h=>(()=>{var $=Se();return $.value=h,u($,h),$})()}),null),r})(),(()=>{var r=be();return r.$$click=()=>{t?l.createOffer(t):alert("请选择 Peer ID")},M(()=>r.disabled=!E()),r})()]}}),null),P.addEventListener("focus",r=>r.target.select()),P.addEventListener("change",r=>_(r.target.value)),L.$$click=()=>{l.sendMessage(S())},u(F,b,N),N.addEventListener("change",async r=>{const h=r.target.files?.[0];h!==void 0&&(console.log("文件选择",h),r.target.value="",n=he(h,32*1024),console.log("分块",n),l.sendMessage({file:{type:"showSaveFilePicker",name:h.name,chunks:n.length}}))}),u(Q,y(xe,{onFileWriter:r=>{e=r;const h=A();h&&(B(0),l.sendMessage({file:{...h,type:"beginRecieve"}}))}})),u(W,()=>l.id),u(Y,()=>a()??"unknown"),u(ee,k),u(o,w,null),M(r=>{var h=!E(),$=T()===!1;return h!==r.e&&(g.disabled=r.e=h),$!==r.t&&(L.disabled=r.t=$),r},{e:void 0,t:void 0}),M(()=>P.value=S()),o})()},[A,j]=m(),[U,B]=m(0);function xe(l){return y(J,{get when(){return A()},keyed:!0,children:t=>[(()=>{var e=ye();return e.$$click=async()=>{const n=await fe(t.name);l.onFileWriter(n)},e})(),_e(),(()=>{var e=ke(),n=e.firstChild,i=n.nextSibling,s=i.nextSibling,a=s.nextSibling;return a.nextSibling,u(e,()=>t?.name,i),u(e,()=>t.chunks,a),u(e,U,null),e})()]})}H(["click"]);const De=document.getElementById("root");le(()=>y(Oe,{}),De);
