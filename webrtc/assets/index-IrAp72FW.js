import{M as te,d as H,c as C,t as v,u as F,i as f,a as T,o as ne,b as ie,e as se,f as k,F as oe,S as J,r as le}from"./vendor-CfKRxhm_.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function e(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(i){if(i.ep)return;i.ep=!0;const s=e(i);fetch(i.href,s)}})();class re{client;topic;constructor({url:t,topic:e}){this.topic=e,this.client=te.connect(t,{reconnectPeriod:5e3})}set handleConnectEvent(t){const{client:e,topic:n}=this;e.on("connect",()=>{e.subscribe(n,i=>{i?console.error("Subscribe error:",i):(console.log(`Subscribed to topic: ${n}`),t())})})}set handleMessageEvent(t){const{client:e,topic:n}=this;e.on("message",(i,s)=>{const r=s.toString();console.log(`Received message on topic ${i}`),i===n&&t(r)})}set handleErrorEvent(t){const{client:e}=this;e.on("error",n=>{t(n)})}set handleCloseEvent(t){const{client:e}=this;e.on("close",()=>{t()})}send(t){const{client:e,topic:n}=this;e.publish(n,t,i=>{i?console.error("Publish error:",i):console.log(`Published message to topic: ${n}`)})}close(){this.client.end()}}const ae=8*1024*1024,ce=1*1024*1024;class de{pc=null;dataChannel=null;cli;id=crypto.randomUUID();peerId;onMessage;onConnState;onPeerID;onStream;constructor({onMessage:t,onConnState:e,onPeerID:n,onStream:i}){console.log("åˆå§‹åŒ– WebRTCDemo",this.id);const s="wss://test.mosquitto.org:8081";this.cli=new re({url:s,topic:"test/webrtc/topic"}),this.onMessage=t,this.onConnState=e,this.onPeerID=n,this.onStream=i,this.cli.handleConnectEvent=()=>{console.log("æˆåŠŸè¿æ¥åˆ°ä¿¡ä»¤æœåŠ¡å™¨"),this.initializePeerConnection(),this.onConnState("cli_connected")},this.cli.handleMessageEvent=async r=>{const c=JSON.parse(r);if(c.id!==this.id)if(console.log("ä»ä¿¡ä»¤æœåŠ¡å™¨æ”¶åˆ°æ¶ˆæ¯:",c),c.type==="PeerID")this.onPeerID(c.id);else if(c.offer){if(c.offer.peerId!==this.id)return;await this.receiveOffer(c.id,c.offer.desc)}else c.answer?await this.receiveAnswer(c.answer):c.candidate&&await this.addIceCandidate(c.candidate)},this.cli.handleErrorEvent=r=>{console.error("ä¿¡ä»¤æœåŠ¡å™¨è¿æ¥é”™è¯¯:",r)},this.cli.handleCloseEvent=()=>{console.log("ä¸ä¿¡ä»¤æœåŠ¡å™¨çš„è¿æ¥å·²æ–­å¼€")}}destroy(){this.cli.close(),this.pc?.close()}sendSignalingMessage(t){this.cli.send(JSON.stringify(t))}initializePeerConnection(){const t={iceServers:[{urls:"stun:stun.miwifi.com"}]};this.pc=new RTCPeerConnection(t),this.pc.onicecandidate=e=>{e.candidate&&(console.log("å‘é€æœ¬åœ° ICE candidate:",e.candidate),this.sendSignalingMessage({id:this.id,candidate:e.candidate}))},this.pc.ondatachannel=e=>{console.log("æ”¶åˆ°è¿œç¨‹æ•°æ®é€šé“"),this.dataChannel=e.channel,this.setupDataChannel()},this.pc.oniceconnectionstatechange=()=>{console.log("ICE è¿æ¥çŠ¶æ€:",this.pc?.iceConnectionState),this.pc?.iceConnectionState==="failed"&&console.error("ICE è¿æ¥å¤±è´¥ã€‚")},this.pc.onconnectionstatechange=()=>{console.log("Connection çŠ¶æ€:",this.pc?.connectionState),this.onConnState(this.pc?.connectionState)},this.pc.ontrack=e=>{for(const n of e.streams)this.onStream(n);console.log("æ”¶åˆ°è¿œç¨‹åª’ä½“æµ",e.streams.length)},this.pc.onnegotiationneeded=async()=>{console.log("ğŸ§  è§¦å‘ renegotiation"),this.peerId&&this.renegotiate(this.peerId)}}async createOffer(t){if(this.pc){this.peerId=t,console.log("åˆ›å»º Offer..."),this.dataChannel=this.pc.createDataChannel("messageChannel"),this.setupDataChannel();try{const e=await this.pc.createOffer();await this.pc.setLocalDescription(e),console.log("å‘é€æœ¬åœ° Offer:",e),this.sendSignalingMessage({id:this.id,offer:{desc:e,peerId:t}})}catch(e){console.error("åˆ›å»º Offer æ—¶å‡ºé”™:",e)}}}async receiveOffer(t,e){if(this.pc){this.peerId=t,console.log("æ”¶åˆ° Offer, åˆ›å»º Answer...");try{await this.pc.setRemoteDescription(new RTCSessionDescription(e));const n=await this.pc.createAnswer();await this.pc.setLocalDescription(n),console.log("å‘é€æœ¬åœ° Answer:",n),this.sendSignalingMessage({id:this.id,answer:n})}catch(n){console.error("å¤„ç† Offer æ—¶å‡ºé”™:",n)}}}async receiveAnswer(t){if(this.pc){console.log("æ”¶åˆ° Answer");try{await this.pc.setRemoteDescription(new RTCSessionDescription(t))}catch(e){console.error("å¤„ç† Answer æ—¶å‡ºé”™:",e)}}}async addIceCandidate(t){if(this.pc){console.log("æ·»åŠ è¿œç¨‹ ICE Candidate");try{await this.pc.addIceCandidate(new RTCIceCandidate(t))}catch(e){console.error("æ·»åŠ  ICE candidate æ—¶å‡ºé”™:",e)}}}setupDataChannel(){this.dataChannel&&(this.dataChannel.bufferedAmountLowThreshold=ce,this.dataChannel.onopen=()=>{console.log("æ•°æ®é€šé“å·²æ‰“å¼€"),this.sendMessage(`hello from ${this.id}`)},this.dataChannel.onclose=()=>{console.log("æ•°æ®é€šé“å·²å…³é—­")},this.dataChannel.onerror=t=>{console.error("æ•°æ®é€šé“é”™è¯¯:",t)},this.dataChannel.onmessage=t=>{console.log("æ”¶åˆ°æ¶ˆæ¯:",typeof t.data),this.onMessage(t.data)},this.dataChannel.onbufferedamountlow=()=>{console.log("æ•°æ®é€šé“ç¼“å†²åŒºå·²ç©ºé—²");const t=this.writable;this.writable=void 0,t?.()})}writable;sendMessage(t){this.dataChannel&&this.dataChannel.readyState==="open"?(this.dataChannel.send(JSON.stringify(t)),console.log("å·²å‘é€æ¶ˆæ¯:",t)):console.warn("æ•°æ®é€šé“æœªæ‰“å¼€ï¼Œæ— æ³•å‘é€æ¶ˆæ¯ã€‚å½“å‰çŠ¶æ€:",this.dataChannel?.readyState)}async sendData(t){if(this.writable)throw new Error("wait until writable");if(this.dataChannel&&this.dataChannel.readyState==="open"){if(this.dataChannel.bufferedAmount>ae){await new Promise(e=>{this.writable=e}),this.sendData(t);return}try{this.dataChannel.send(t)}catch(e){console.error("å‘é€æ•°æ®æ—¶å‡ºé”™:",e)}}else console.warn("æ•°æ®é€šé“æœªæ‰“å¼€ï¼Œæ— æ³•å‘é€æ¶ˆæ¯ã€‚å½“å‰çŠ¶æ€:",this.dataChannel?.readyState)}signal(t){this.cli.send(JSON.stringify(t))}addTrack(t,e){return this.pc?.addTrack(t,e)}removeTrack(t){return this.pc?.removeTrack(t)}async renegotiate(t){if(this.pc){console.log("é‡æ–°åå•† Offer...");try{const e=await this.pc.createOffer();await this.pc.setLocalDescription(e),console.log("å‘é€æœ¬åœ° Offer:",e),this.sendSignalingMessage({id:this.id,offer:{desc:e,peerId:t}})}catch(e){console.error("åˆ›å»º Offer æ—¶å‡ºé”™:",e)}}}}function he(o,t=1024*1024){const e=[];for(let n=0;n<o.size;n+=t)e.push(o.slice(n,n+t));return e}async function fe(o){const e=await(await window.showSaveFilePicker({suggestedName:o})).createWritable();return[async s=>{await e.write(s)},()=>{e.close()},e]}var ue=v("<button>è§†é¢‘è¯­éŸ³"),ge=v("<dialog style=width:50vw;height:50vh;><button>Video: </button><button>Audio: </button><button>Mute</button><button>å…³é—­</button><hr><video autoplay playsinline style=width:128px;height:96px;></video><video autoplay playsinline muted style=width:64px;height:48px;>");function pe(o){let t=null,e=null,n=null,i=new MediaStream,s=null,r=null,c,b;const[O,x]=C(!1),[D,M]=C(!1),E=g=>{n!==null&&(n.srcObject=g)},I=(()=>{var g=ue();return g.$$click=()=>{t?.showModal()},g})();return[(()=>{var g=ge(),S=g.firstChild;S.firstChild;var $=S.nextSibling;$.firstChild;var l=$.nextSibling,d=l.nextSibling,u=d.nextSibling,m=u.nextSibling,w=m.nextSibling;return F(p=>t=p,g),S.$$click=async()=>{if(e!==null)if(s)c&&(o.removeTrack(c),c=void 0),i.removeTrack(s),s.stop(),s=null,console.log("ğŸ“¹ Video track removed"),e.srcObject=null,x(!1);else{s=(await navigator.mediaDevices.getUserMedia({video:{width:{min:320,ideal:640,max:640},height:{min:240,ideal:480,max:480}}})).getVideoTracks()[0];try{await s.applyConstraints(ve),console.log("Video constraints applied successfully.")}catch(_){console.error("Failed to apply video constraints:",_)}i.addTrack(s),c=o.addTrack(s,i),console.log("ğŸ“¹ Video track added"),e.srcObject=i,x(!0)}},f(S,()=>O()?"ON":"OFF",null),$.$$click=async()=>{e!==null&&(r?(b&&(o.removeTrack(b),b=void 0),i.removeTrack(r),r.stop(),r=null,console.log("ğŸ“¹ Audio track removed"),e.srcObject=null,M(!1)):(r=(await navigator.mediaDevices.getUserMedia(me)).getAudioTracks()[0],i.addTrack(r),b=o.addTrack(r,i),console.log("ğŸ“¹ Audio track added"),e.srcObject=i,M(!0)))},f($,()=>D()?"ON":"OFF",null),l.$$click=()=>{e&&(e.muted=!e.muted)},d.$$click=()=>t?.close(),F(p=>n=p,m),F(p=>e=p,w),T(()=>d.disabled=O()||D()),g})(),I,E]}const ve={advanced:[{frameRate:{ideal:10}}]},me={audio:{bitrate:{ideal:48e3},channelCount:{ideal:1},echoCancellation:!0}};H(["click"]);var Ce=v("<label for=peer_ids>Peer ID List: "),we=v("<select id=peer_ids style=width:320px;><option value>========== è¯·é€‰æ‹© Peer ID ==========="),be=v("<button>å‘é€ Offer"),Se=v('<div><p><button>å¹¿æ’­ ID</button></p><div class=flex><div class=flex-1><div><textarea id=text rows=3></textarea></div><p><button>å‘é€</button></p></div><div class=flex-1><div><input id=file type=file placeholder=æ–‡ä»¶></div><p></p></div></div><p>Id: <mark></mark>, State: <b><i></i></b></p><p>Message:</p><div class="break font">'),$e=v("<option>"),ye=v("<button>æ¥æ”¶å¹¶ä¿å­˜"),_e=v("<br>"),ke=v("<i class=font>æ–‡ä»¶ï¼š<!>ï¼ŒåŒºå—ï¼š<!>ï¼Œå·²æ¥æ”¶ï¼š");const Oe=()=>{const o=new de({onConnState(l){l==="cli_connected"?P(!0):l==="cli_disconnected"?P(!1):c(l)},async onMessage(l){if(typeof l=="string"){const d=JSON.parse(l);if(d.file){if(d.file.type==="showSaveFilePicker")j(d.file);else if(d.file.type==="beginRecieve"&&n)for(const u of n)await o.sendData(u)}M(l)}else if(l instanceof ArrayBuffer&&e){const d=R();d?.type;const[u,m]=e;u(l);const w=U()+1;B(w),d?.chunks===w&&(m(),j(void 0),alert("æ–‡ä»¶ä¿å­˜æˆåŠŸ")),console.log("receivedChunk",w)}else console.log("onMessage",l)},onPeerID(l){s(d=>{const u=d.filter(m=>m!==l);return u.unshift(l),u})},onStream(l){$(l)}});ne(()=>{console.log("App mounted")}),ie(()=>{console.log("App onCleanup"),o.destroy()});let t="",e=null,n=null;const[i,s]=C([]),[r,c]=C(),[b,O]=C(""),[x,D]=C(""),M=l=>{D(d=>l+`
`+d)},E=se(()=>r()==="connected"),[I,P]=C(!1),[g,S,$]=pe(o);return(()=>{var l=Se(),d=l.firstChild,u=d.firstChild,m=d.nextSibling,w=m.firstChild,p=w.firstChild,_=p.firstChild,q=p.nextSibling,L=q.firstChild,z=w.nextSibling,A=z.firstChild,N=A.firstChild,Q=A.nextSibling,W=m.nextSibling,K=W.firstChild,V=K.nextSibling,X=V.nextSibling,G=X.nextSibling,Y=G.firstChild,Z=W.nextSibling,ee=Z.nextSibling;return u.$$click=()=>o.signal({id:o.id,type:"PeerID"}),f(d,k(J,{get when(){return i().length>0},get children(){return[Ce(),(()=>{var a=we();return a.firstChild,a.addEventListener("change",h=>{console.log("select peer id",h.target.value),t=h.target.value}),f(a,k(oe,{get each(){return i()},children:h=>(()=>{var y=$e();return y.value=h,f(y,h),y})()}),null),a})(),(()=>{var a=be();return a.$$click=()=>{t?o.createOffer(t):alert("è¯·é€‰æ‹© Peer ID")},T(()=>a.disabled=!I()),a})()]}}),null),_.addEventListener("focus",a=>a.target.select()),_.addEventListener("change",a=>O(a.target.value)),L.$$click=()=>{o.sendMessage(b())},f(A,S,N),N.addEventListener("change",async a=>{const h=a.target.files?.[0];h!==void 0&&(console.log("æ–‡ä»¶é€‰æ‹©",h),a.target.value="",n=he(h,32*1024),console.log("åˆ†å—",n),o.sendMessage({file:{type:"showSaveFilePicker",name:h.name,chunks:n.length}}))}),f(Q,k(xe,{onFileWriter:a=>{e=a;const h=R();h&&(B(0),o.sendMessage({file:{...h,type:"beginRecieve"}}))}})),f(V,()=>o.id),f(Y,()=>r()??"unknown"),f(ee,x),f(l,g,null),T(a=>{var h=!I(),y=E()===!1;return h!==a.e&&(u.disabled=a.e=h),y!==a.t&&(L.disabled=a.t=y),a},{e:void 0,t:void 0}),T(()=>_.value=b()),l})()},[R,j]=C(),[U,B]=C(0);function xe(o){return k(J,{get when(){return R()},keyed:!0,children:t=>[(()=>{var e=ye();return e.$$click=async()=>{const n=await fe(t.name);o.onFileWriter(n)},e})(),_e(),(()=>{var e=ke(),n=e.firstChild,i=n.nextSibling,s=i.nextSibling,r=s.nextSibling;return r.nextSibling,f(e,()=>t?.name,i),f(e,()=>t.chunks,r),f(e,U,null),e})()]})}H(["click"]);const De=document.getElementById("root");le(()=>k(Oe,{}),De);
