import{M as oe,d as K,c as w,t as g,u as U,i as h,a as b,S as E,o as re,b as ae,e as le,f as T,F as ce,r as de}from"./vendor-DcnpxILq.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function e(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(i){if(i.ep)return;i.ep=!0;const r=e(i);fetch(i.href,r)}})();class he{client;topic;constructor({url:t,topic:e}){this.topic=e,this.client=oe.connect(t,{reconnectPeriod:1e4})}set handleConnectEvent(t){const{client:e,topic:n}=this;e.on("connect",()=>{e.subscribe(n,i=>{i?console.error("Subscribe error:",i):(console.log(`Subscribed to topic: ${n}`),t())})})}set handleMessageEvent(t){const{client:e,topic:n}=this;e.on("message",(i,r)=>{const c=r.toString();console.log(`Received message on topic ${i}`),i===n&&t(c)})}set handleErrorEvent(t){const{client:e}=this;e.on("error",n=>{t(n)})}set handleCloseEvent(t){const{client:e}=this;e.on("close",()=>{t()})}send(t){const{client:e,topic:n}=this;e.publish(n,t,i=>{i?console.error("Publish error:",i):console.log(`Published message to topic: ${n}`)})}close(){this.client.end()}}window.name||(window.name=crypto.randomUUID());const ue=8*1024*1024,ge=1*1024*1024;class fe{pc=null;dataChannel=null;signal;id=window.name;peerId;onMessage;onConnState;onPeerID;onStream;constructor({onMessage:t,onConnState:e,onPeerID:n,onStream:i}){console.log("初始化 WebRTCDemo",this.id);const r="wss://test.mosquitto.org:8081";this.signal=new he({url:r,topic:"test/webrtc/topic"}),this.onMessage=t,this.onConnState=e,this.onPeerID=n,this.onStream=i,this.signal.handleConnectEvent=()=>{console.log("成功连接到信令服务器"),this.initializePeerConnection(),this.onConnState("signal_connected")},this.signal.handleMessageEvent=async c=>{const l=JSON.parse(c);if(l.id!==this.id)if(console.log("从信令服务器收到消息:",l),l.type==="PeerID")this.onPeerID(l.id);else if(l.type==="Reload")this.onMessage(l),this.sendSignalingMessage({type:"Reloading",id:this.id}),setTimeout(()=>{window.location.reload()},2e3);else if(l.type==="GiveMeOffer"){if(l.peerId!==this.id)return;this.createOffer(l.id)}else if(l.offer){if(l.peerId!==this.id)return;await this.receiveOffer(l.id,l.offer.desc)}else l.answer?await this.receiveAnswer(l.answer):l.candidate&&await this.addIceCandidate(l.candidate)},this.signal.handleErrorEvent=c=>{console.error("信令服务器连接错误:",c)},this.signal.handleCloseEvent=()=>{console.log("与信令服务器的连接已断开")}}destroy(){this.signal.close(),this.pc?.close()}disconnect(){this.pc?.close(),this.onConnState("closed")}sendSignalingMessage(t){this.signal.send(JSON.stringify(t))}initializePeerConnection(){const t={iceServers:[{urls:"stun:stun.miwifi.com"}]};this.pc=new RTCPeerConnection(t),this.pc.onicecandidate=e=>{e.candidate&&(console.log("发送本地 ICE candidate:",e.candidate),this.sendSignalingMessage({id:this.id,candidate:e.candidate}))},this.pc.ondatachannel=e=>{console.log("收到远程数据通道"),this.dataChannel=e.channel,this.setupDataChannel()},this.pc.oniceconnectionstatechange=()=>{console.log("ICE 连接状态:",this.pc?.iceConnectionState),this.pc?.iceConnectionState==="failed"&&console.error("ICE 连接失败。")},this.pc.onconnectionstatechange=()=>{console.log("Connection 状态:",this.pc?.connectionState),this.onConnState(this.pc?.connectionState)},this.pc.onsignalingstatechange=()=>{console.log("Signaling 状态:",this.pc?.signalingState)},this.pc.ontrack=e=>{for(const n of e.streams)this.onStream(n);console.log("收到远程媒体流",e.streams.length)},this.pc.onnegotiationneeded=async()=>{console.log("🧠 触发 renegotiation"),this.peerId&&this.renegotiate(this.peerId)}}async createOffer(t){if(this.pc){this.peerId=t,console.log("创建 Offer..."),this.dataChannel=this.pc.createDataChannel("messageChannel"),this.setupDataChannel();try{const e=await this.pc.createOffer();await this.pc.setLocalDescription(e),console.log("发送本地 Offer:",e),this.sendSignalingMessage({id:this.id,peerId:t,offer:{desc:e}})}catch(e){console.error("创建 Offer 时出错:",e)}}}async receiveOffer(t,e){if(this.pc){this.peerId=t,console.log("收到 Offer, 创建 Answer...");try{await this.pc.setRemoteDescription(new RTCSessionDescription(e));const n=await this.pc.createAnswer();await this.pc.setLocalDescription(n),console.log("发送本地 Answer:",n),this.sendSignalingMessage({id:this.id,answer:n})}catch(n){console.error("处理 Offer 时出错:",n)}}}async receiveAnswer(t){if(this.pc){console.log("收到 Answer");try{await this.pc.setRemoteDescription(new RTCSessionDescription(t))}catch(e){console.error("处理 Answer 时出错:",e)}}}async addIceCandidate(t){if(this.pc){console.log("添加远程 ICE Candidate");try{await this.pc.addIceCandidate(new RTCIceCandidate(t))}catch(e){console.error("添加 ICE candidate 时出错:",e)}}}setupDataChannel(){this.dataChannel&&(this.dataChannel.bufferedAmountLowThreshold=ge,this.dataChannel.onopen=()=>{console.log("数据通道已打开"),this.sendMessage(`hello from ${this.id}`)},this.dataChannel.onclose=()=>{console.log("数据通道已关闭")},this.dataChannel.onerror=t=>{console.error("数据通道错误:",t)},this.dataChannel.onmessage=t=>{console.log("收到消息:",typeof t.data),this.onMessage(t.data)},this.dataChannel.onbufferedamountlow=()=>{console.log("数据通道缓冲区已空闲");const t=this.writable;this.writable=void 0,t?.()})}writable;sendMessage(t){this.dataChannel&&this.dataChannel.readyState==="open"?(this.dataChannel.send(JSON.stringify(t)),console.log("已发送消息:",t)):console.warn("数据通道未打开，无法发送消息。当前状态:",this.dataChannel?.readyState)}async sendData(t){if(this.writable)throw new Error("wait until writable");if(this.dataChannel&&this.dataChannel.readyState==="open"){if(this.dataChannel.bufferedAmount>ue){await new Promise(e=>{this.writable=e}),this.sendData(t);return}try{this.dataChannel.send(t)}catch(e){console.error("发送数据时出错:",e)}}else console.warn("数据通道未打开，无法发送消息。当前状态:",this.dataChannel?.readyState)}addTrack(t,e){return this.pc?.addTrack(t,e)}removeTrack(t){try{return this.pc?.removeTrack(t)}catch(e){console.error("Failed to remove track:",e)}}async renegotiate(t){if(this.pc){console.log("重新协商 Offer...");try{const e=await this.pc.createOffer();await this.pc.setLocalDescription(e),console.log("发送本地 Offer:",e),this.sendSignalingMessage({id:this.id,peerId:t,offer:{desc:e}})}catch(e){console.error("创建 Offer 时出错:",e)}}}get peerConnection(){return this.pc}}function pe(o,t=1024*1024){const e=[];for(let n=0;n<o.size;n+=t)e.push(o.slice(n,n+t));return e}async function me(o){const e=await(await window.showSaveFilePicker({suggestedName:o})).createWritable();return[async r=>{await e.write(r)},()=>{e.close()},e]}var ve=g("<button>视频语音"),we=g("<select><option value>分辨率"),Ce=g("<dialog style=width:50rem;height:30rem;max-width:88%;max-height:88%;><button>Video: </button><button>Audio: </button><button>Mute</button><button>关闭</button><p><select><option value>摄像头</option><option value=user>前置摄像头</option><option value=environment>后置摄像头</option></select></p><hr><video autoplay playsinline style=width:128px;height:96px;></video><video autoplay playsinline muted style=width:64px;height:48px;>"),$e=g("<option>");function Se(o){let t=null,e=null,n=null,i=new MediaStream,r=null,c=null,l,M,_=!0,P;const[W,R]=w(!1),[I,O]=w(!1),A=m=>{n!==null&&(n.srcObject=m)},F=(()=>{var m=ve();return m.$$click=()=>{t?.showModal()},m})();return[(()=>{var m=Ce(),x=m.firstChild;x.firstChild;var a=x.nextSibling;a.firstChild;var d=a.nextSibling,p=d.nextSibling,v=p.nextSibling,C=v.firstChild,L=v.nextSibling,D=L.nextSibling,j=D.nextSibling;return U(u=>t=u,m),x.$$click=async()=>{if(e!==null)if(r)l&&(o.removeTrack(l),l=void 0),i.removeTrack(r),r.stop(),r=null,console.log("📹 Video track removed"),e.pause(),R(!1);else{const u=_===!0?!0:Object.assign({facingMode:P},X,_);r=(await navigator.mediaDevices.getUserMedia({video:u})).getVideoTracks()[0],i.addTrack(r),l=o.addTrack(r,i),console.log("📹 Video track added"),e.srcObject=i,R(!0)}},h(x,()=>W()?"ON":"OFF",null),a.$$click=async()=>{e!==null&&(c?(M&&(o.removeTrack(M),M=void 0),i.removeTrack(c),c.stop(),c=null,console.log("📹 Audio track removed"),e.muted=!0,O(!1)):(c=(await navigator.mediaDevices.getUserMedia(be)).getAudioTracks()[0],i.addTrack(c),M=o.addTrack(c,i),console.log("📹 Audio track added"),e.srcObject=i,O(!0)))},h(a,()=>I()?"ON":"OFF",null),d.$$click=()=>{e&&(e.muted=!e.muted)},p.$$click=()=>t?.close(),h(v,b(E,{get when(){return y.frameRate&&y.width&&y.height},get children(){var u=we();return u.firstChild,u.addEventListener("change",S=>{_=J[S.currentTarget.value]??!0}),h(u,()=>Object.keys(J).map(S=>(()=>{var k=$e();return k.value=S,h(k,S),k})()),null),u}}),C),C.addEventListener("change",u=>{P=u.currentTarget.value}),U(u=>n=u,D),U(u=>e=u,j),m})(),F,A]}const y=navigator.mediaDevices.getSupportedConstraints();console.debug("supportedConstraints",y);const be={audio:y.sampleRate&&y.sampleSize&&y.echoCancellation&&y.channelCount?{sampleSize:{ideal:8},channelCount:{ideal:1},echoCancellation:!0}:!0},X={width:{min:640,ideal:800,max:1024},height:{min:480,ideal:600,max:768},frameRate:{min:5,ideal:5,max:5}},J={default:X,"160*120":{width:160,height:120},"320*240":{width:320,height:240},"640*480":{width:640,height:480},"800*600":{width:800,height:600}};K(["click"]);var ye=g("<button>Reload"),_e=g("<button>GiveMeOffer"),ke=g("<button>Close"),Me=g("<label for=peer_ids>Peer ID List: "),Oe=g("<select id=peer_ids style=width:320px;><option value>========== 请选择 Peer ID ==========="),xe=g("<button>发送 Offer"),De=g("<div><input id=file type=file placeholder=文件>"),Ie=g('<div><p><button>广播 ID</button></p><div class="flex wrap"><div style="flex:0 0 300px;"><div><textarea id=text rows=3></textarea></div><p><button>发送</button></p></div><div class=flex-1><p></p></div></div><p>Id: <mark></mark>, State: <b><i></i></b></p><p>Message:</p><div class="break font">'),Te=g("<option>"),Ee=g("<button>接收并保存"),Pe=g("<br>"),Re=g("<i class=font>文件：<!>，区块：<!>，已接收：");const G=new URLSearchParams(window.location.search).has("master"),Ae=()=>{const o=new fe({onConnState(a){a==="signal_connected"?(F(!0),o.sendSignalingMessage({type:"PeerID",id:o.id})):a==="signal_disconnected"?F(!1):M(a)},async onMessage(a){if(typeof a=="string"){const d=JSON.parse(a);if(d.file){if(d.file.type==="showSaveFilePicker")q(d.file);else if(d.file.type==="beginRecieve"&&e)for(const p of e)await o.sendData(p)}I(a)}else if(a instanceof ArrayBuffer&&t){const d=V();d?.type;const[p,v]=t;p(a);const C=Y()+1;Q(C),d?.chunks===C&&(v(),q(void 0),alert("文件保存成功")),console.log("receivedChunk",C)}else console.log("onMessage",a)},onPeerID(a){c(d=>{const p=d.filter(v=>v!==a);return p.unshift(a),p}),I(`收到 PeerID： ${a} - ${new Date().toLocaleTimeString()}`)},onStream(a){x(a)}});re(()=>{console.log("App mounted")}),ae(()=>{console.log("App onCleanup"),o.destroy()});let t=null,e=null;const[n,i]=w(""),[r,c]=w([]),[l,M]=w(),[_,P]=w(""),[W,R]=w([]),I=a=>{R(d=>(d.unshift(a),d.slice(0,30)))},O=le(()=>l()==="connected"),[A,F]=w(!1),[B,m,x]=Se(o);return(()=>{var a=Ie(),d=a.firstChild,p=d.firstChild,v=d.nextSibling,C=v.firstChild,L=C.firstChild,D=L.firstChild,j=L.nextSibling,u=j.firstChild,S=C.nextSibling,k=S.firstChild,H=v.nextSibling,Z=H.firstChild,z=Z.nextSibling,ee=z.nextSibling,te=ee.nextSibling,ne=te.firstChild,ie=H.nextSibling,se=ie.nextSibling;return p.$$click=()=>o.sendSignalingMessage({id:o.id,type:"PeerID"}),h(d,b(E,{when:G,get children(){return[(()=>{var s=ye();return s.$$click=()=>{o.sendSignalingMessage({type:"Reload",id:o.id})},s})(),(()=>{var s=_e();return s.$$click=()=>{n()&&o.sendSignalingMessage({type:"GiveMeOffer",id:o.id,peerId:n()})},T(()=>s.disabled=!n()),s})(),(()=>{var s=ke();return s.$$click=()=>{o.disconnect()},T(()=>s.disabled=!O()),s})()]}}),null),h(d,b(E,{get when(){return r().length>0},get children(){return[Me(),(()=>{var s=Oe();return s.firstChild,s.addEventListener("change",f=>{console.log("select peer id",f.target.value),i(f.target.value)}),h(s,b(ce,{get each(){return r()},children:f=>(()=>{var $=Te();return $.value=f,h($,f),$})()}),null),s})(),(()=>{var s=xe();return s.$$click=()=>{n()&&o.createOffer(n())},T(()=>s.disabled=!A()||!n()),s})()]}}),null),D.addEventListener("focus",s=>s.target.select()),D.addEventListener("change",s=>P(s.target.value)),u.$$click=()=>{I("me: "+_()),o.sendMessage(_())},h(S,b(E,{get when(){return O()||G},get children(){var s=De(),f=s.firstChild;return h(s,m,f),f.addEventListener("change",async $=>{const N=$.target.files?.[0];N!==void 0&&(console.log("文件选择",N),$.target.value="",e=pe(N,32*1024),console.log("分块",e),o.sendMessage({file:{type:"showSaveFilePicker",name:N.name,chunks:e.length}}))}),s}}),k),h(k,b(Fe,{onFileWriter:s=>{t=s;const f=V();f&&(Q(0),o.sendMessage({file:{...f,type:"beginRecieve"}}))}})),h(z,()=>o.id),h(ne,()=>l()??"unknown"),h(se,()=>W().join(`
`)),h(a,B,null),T(s=>{var f=!A(),$=O()===!1;return f!==s.e&&(p.disabled=s.e=f),$!==s.t&&(u.disabled=s.t=$),s},{e:void 0,t:void 0}),T(()=>D.value=_()),a})()},[V,q]=w(),[Y,Q]=w(0);function Fe(o){return b(E,{get when(){return V()},keyed:!0,children:t=>[(()=>{var e=Ee();return e.$$click=async()=>{const n=await me(t.name);o.onFileWriter(n)},e})(),Pe(),(()=>{var e=Re(),n=e.firstChild,i=n.nextSibling,r=i.nextSibling,c=r.nextSibling;return c.nextSibling,h(e,()=>t?.name,i),h(e,()=>t.chunks,c),h(e,Y,null),e})()]})}K(["click"]);const Le=document.getElementById("root");de(()=>b(Ae,{}),Le);
